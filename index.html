<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPad用 PiPタイマー</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; text-align: center; padding: 50px; background: #f4f4f9; }
        canvas { background: #000; display: none; }
        button { padding: 20px 40px; font-size: 20px; border-radius: 12px; border: none; background: #007aff; color: white; cursor: pointer; margin: 10px; }
        button:active { opacity: 0.7; }
    </style>
</head>
<body>
    <h1>PiP Timer</h1>
    <canvas id="c" width="400" height="200"></canvas>
    <video id="v" autoplay muted playsinline style="display:none;"></video>
    
    <div>
        <button id="pipBtn">タイマーを浮かせる (PiP)</button>
        <button id="resetBtn" style="background:#8e8e93;">リセット</button>
    </div>

    <script>
        const canvas = document.getElementById('c'), ctx = canvas.getContext('2d');
        const video = document.getElementById('v'), pipBtn = document.getElementById('pipBtn');
        const resetBtn = document.getElementById('resetBtn');
        let seconds = 0, lastUpdate = Date.now(), running = false;

        function draw() {
            if (running) {
                const now = Date.now();
                if (now - lastUpdate >= 1000) { seconds++; lastUpdate = now; }
            }
            ctx.fillStyle = 'black'; ctx.fillRect(0, 0, 400, 200);
            ctx.fillStyle = 'white'; ctx.font = 'bold 80px monospace';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            ctx.fillText(`${m}:${s}`, 200, 100);
            requestAnimationFrame(draw);
        }

        pipBtn.onclick = async () => {
            video.srcObject = canvas.captureStream(10);
            await video.play();
            await video.requestPictureInPicture();
        };

        // PiP窓の「再生・停止」ボタンと連ation
        video.onplay = () => { running = true; lastUpdate = Date.now(); };
        video.onpause = () => { running = false; };
        resetBtn.onclick = () => { seconds = 0; };
        
        draw();
    </script>
</body>
</html>